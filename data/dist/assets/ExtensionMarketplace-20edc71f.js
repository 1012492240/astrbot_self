import{E as w}from"./ExtensionCard-c79693d6.js";import{W as P}from"./WaitingForRestart-0476b659.js";import{A as R}from"./AstrBotConfig-568869c1.js";import{_ as E}from"./ConsoleDisplayer-9b3eae3d.js";import{o as i,m as d,b as s,w as l,X as _,W as B,a9 as U,F as k,l as y,c as f,aa as z,Y as g,g as V,E as b,G as C,q as o,v as c,f as v,e as h,x as H,t as m,D as M,S as L,H as S,p as D,R as T,y as A,I,ab as G,U as N,V as W}from"./index-11f1cd8c.js";import{u as F}from"./common-34a2a7ab.js";import"./_plugin-vue_export-helper-c27b6911.js";const $={class:"pl-2 pt-2 d-flex align-center pe-2"},j=o("h2",null,"✨ 插件市场",-1),q=o("span",null," 如无法显示，请单击此按钮跳转至插件市场，复制想安装插件对应的 `repo` 链接然后点击右下角 + 号安装，或打开链接下载压缩包安装。 如果因为网络问题安装失败，点击设置页选择 GitHub 加速地址。或前往仓库下载压缩包然后本地上传。 ",-1),K={key:0,class:"mt-4"},O=o("h2",null,"🥳 推荐",-1),X={key:1,class:"mt-4"},Y=o("h2",null,"📦 全部插件",-1),Z={class:"d-flex align-center"},J=["src"],Q={key:1},ee=["href"],te={key:2},ae={key:0},se=["href"],le={key:1},ne={key:0},oe={key:2,class:"mt-4"},ie=o("h2",null,"📦 全部插件",-1),re=o("small",null,[o("a",{href:"https://astrbot.app/dev/plugin.html"},"插件开发文档")],-1),de=o("small",null,[o("a",{href:"https://github.com/Soulter/AstrBot_Plugins_Collection"},"提交插件仓库")],-1),ue=o("span",{class:"text-h5"},"安装插件",-1),he=o("h3",null,"从 GitHub 上在线下载",-1),pe=o("small",null,"请输入合法的 GitHub 仓库链接，当前仅支持 GitHub。如：https://github.com/Soulter/astrbot_plugin_aiocqhttp",-1),ge=o("h3",null,"从本机上传 .zip 压缩包",-1),me=o("small",null,"请保证插件文件存在压缩包根目录中的第一个文件夹中（即类似于从 GitHub 仓库页上下载的 Zip 压缩包的格式）。",-1),ce=o("br",null,null,-1),fe={name:"ExtensionPage",components:{ExtensionCard:w,WaitingForRestart:P,ConsoleDisplayer:E,AstrBotConfig:R},data(){return{extension_data:{data:[],message:""},extension_url:"",status:"",dialog:!1,snack_message:"",snack_show:!1,snack_success:"success",loading_:!1,upload_file:null,pluginMarketData:[],loadingDialog:{show:!1,title:"加载中...",statusCode:0,result:""},announcement:"",isListView:!0,pluginMarketHeaders:[{title:"名称",key:"name",maxWidth:"150px"},{title:"描述",key:"desc",maxWidth:"250px"},{title:"作者",key:"author",maxWidth:"60px"},{title:"标签",key:"tags",maxWidth:"60px"},{title:"操作",key:"actions",sortable:!1}],marketSearch:"",commonStore:F()}},computed:{filteredPluginMarketData(){if(!this.marketSearch)return this.pluginMarketData;const n=this.marketSearch.toLowerCase();return this.pluginMarketData.filter(e=>e.name.toLowerCase().includes(n))},pinnedPlugins(){return this.pluginMarketData.filter(n=>n==null?void 0:n.pinned)}},mounted(){this.getExtensions(),this.loading_=!0,this.commonStore.getPluginCollections().then(n=>{this.pluginMarketData=n,this.checkAlreadyInstalled(),this.checkUpdate(),this.loading_=!1}).catch(n=>{console.error("获取插件市场数据失败:",n)}),y.get("https://api.soulter.top/astrbot-announcement-plugin-market").then(n=>{let e=n.data.data;this.announcement=e.text})},methods:{jumpToPluginMarket(){window.open("https://soulter.github.io/AstrBot_Plugins_Collection/plugins.json","_blank")},toast(n,e){this.snack_message=n,this.snack_show=!0,this.snack_success=e},resetLoadingDialog(){this.loadingDialog={show:!1,title:"加载中...",statusCode:0,result:""}},onLoadingDialogResult(n,e,a=2e3){this.loadingDialog.statusCode=n,this.loadingDialog.result=e,a!==-1&&setTimeout(()=>{this.resetLoadingDialog()},a)},getExtensions(){y.get("/api/plugin/get").then(n=>{this.extension_data=n.data,this.checkAlreadyInstalled(),this.checkUpdate()})},checkUpdate(){const n=new Map,e=new Map;this.pluginMarketData.forEach(a=>{a.repo&&n.set(a.repo.toLowerCase(),a),e.set(a.name,a)}),this.extension_data.data.forEach(a=>{var x;const t=(x=a.repo)==null?void 0:x.toLowerCase(),p=t?n.get(t):null,r=e.get(a.name),u=p||r;u?(a.online_version=u.version,a.has_update=a.version!==u.version&&u.version!=="未知"):a.has_update=!1})},newExtension(){if(this.extension_url===""&&this.upload_file===null){this.toast("请填写插件链接或上传插件文件","error");return}if(this.extension_url!==""&&this.upload_file!==null){this.toast("请不要同时填写插件链接和上传插件文件","error");return}if(this.loading_=!0,this.loadingDialog.show=!0,this.upload_file!==null){this.toast("正在从文件安装插件","primary");const n=new FormData;n.append("file",this.upload_file),y.post("/api/plugin/install-upload",n,{headers:{"Content-Type":"multipart/form-data"}}).then(e=>{if(this.loading_=!1,e.data.status==="error"){this.onLoadingDialogResult(2,e.data.message,-1);return}this.extension_data=e.data,this.upload_file="",this.onLoadingDialogResult(1,e.data.message),this.dialog=!1}).catch(e=>{this.loading_=!1,this.onLoadingDialogResult(2,e,-1)});return}else this.toast("正在从链接 "+this.extension_url+" 安装插件...","primary"),y.post("/api/plugin/install",{url:this.extension_url,proxy:localStorage.getItem("selectedGitHubProxy")||""}).then(n=>{if(this.loading_=!1,this.toast(n.data.message,n.data.status==="ok"?"success":"error"),n.data.status==="error"){this.onLoadingDialogResult(2,n.data.message,-1);return}this.extension_data=n.data,this.extension_url="",this.onLoadingDialogResult(1,n.data.message),this.dialog=!1}).catch(n=>{this.loading_=!1,this.toast("安装插件失败: "+n,"error"),this.onLoadingDialogResult(2,n,-1)})},checkAlreadyInstalled(){var p;const n=new Set(this.extension_data.data.map(r=>{var u;return(u=r.repo)==null?void 0:u.toLowerCase()})),e=new Set(this.extension_data.data.map(r=>r.name));for(let r=0;r<this.pluginMarketData.length;r++){const u=this.pluginMarketData[r];u.installed=n.has((p=u.repo)==null?void 0:p.toLowerCase())||e.has(u.name)}let a=[],t=[];for(let r=0;r<this.pluginMarketData.length;r++)this.pluginMarketData[r].installed?a.push(this.pluginMarketData[r]):t.push(this.pluginMarketData[r]);this.pluginMarketData=t.concat(a)}}},be=Object.assign(fe,{setup(n){return(e,a)=>(i(),d(k,null,[s(_,null,{default:l(()=>[e.announcement?(i(),f(g,{key:0,cols:"12",md:"12"},{default:l(()=>[s(z,{color:"success",lines:"one",text:e.announcement,stacked:!1},null,8,["text"])]),_:1})):V("",!0),s(g,{cols:"12",md:"12"},{default:l(()=>[s(b,null,{default:l(()=>[s(C,null,{default:l(()=>[o("div",$,[j,s(c,{icon:"",size:"small",style:{"margin-left":"8px"},variant:"plain",onClick:a[0]||(a[0]=t=>e.jumpToPluginMarket())},{default:l(()=>[s(v,{size:"small"},{default:l(()=>[h("mdi-help")]),_:1}),s(H,{activator:"parent",location:"start"},{default:l(()=>[q]),_:1})]),_:1}),s(c,{icon:"",onClick:a[1]||(a[1]=t=>e.isListView=!e.isListView),size:"small",style:{"margin-left":"auto"},variant:"plain"},{default:l(()=>[s(v,null,{default:l(()=>[h(m(e.isListView?"mdi-view-grid":"mdi-view-list"),1)]),_:1})]),_:1}),s(M),s(L,{modelValue:e.marketSearch,"onUpdate:modelValue":a[2]||(a[2]=t=>e.marketSearch=t),density:"compact",label:"Search","prepend-inner-icon":"mdi-magnify",variant:"solo-filled",flat:"","hide-details":"","single-line":""},null,8,["modelValue"])])]),_:1}),s(S,null,{default:l(()=>[e.pinnedPlugins.length>0?(i(),d("div",K,[O,s(_,{style:{"margin-top":"8px"}},{default:l(()=>[(i(!0),d(k,null,D(e.pinnedPlugins,t=>(i(),f(g,{cols:"12",md:"6",lg:"6"},{default:l(()=>[s(w,{extension:t,"market-mode":"true",highlight:!0},null,8,["extension"])]),_:2},1024))),256))]),_:1})])):V("",!0),e.isListView?(i(),d("div",X,[Y,s(g,{cols:"12",md:"12",style:{padding:"0px"}},{default:l(()=>[s(T,{headers:e.pluginMarketHeaders,items:e.pluginMarketData,"item-key":"name",loading:e.loading_,search:e.marketSearch,"onUpdate:search":a[3]||(a[3]=t=>e.marketSearch=t),"filter-keys":["name","desc","author"]},{"item.name":l(({item:t})=>[o("div",Z,[t.logo?(i(),d("img",{key:0,src:t.logo,style:{height:"80px",width:"80px","margin-right":"8px","border-radius":"8px","margin-top":"8px","margin-bottom":"8px"},alt:"logo"},null,8,J)):V("",!0),t!=null&&t.repo?(i(),d("span",Q,[o("a",{href:t==null?void 0:t.repo,style:{color:"#000","text-decoration":"none"}},m(t.name),9,ee)])):(i(),d("span",te,m(t.name),1))])]),"item.author":l(({item:t})=>[t!=null&&t.social_link?(i(),d("span",ae,[o("a",{href:t==null?void 0:t.social_link},m(t.author),9,se)])):(i(),d("span",le,m(t.author),1))]),"item.tags":l(({item:t})=>[t.tags.length===0?(i(),d("span",ne,"无")):V("",!0),(i(!0),d(k,null,D(t.tags,p=>(i(),f(W,{key:p,color:"primary",size:"small"},{default:l(()=>[h(m(p),1)]),_:2},1024))),128))]),"item.actions":l(({item:t})=>[t.installed?(i(),f(c,{key:1,class:"text-none mr-2",size:"small",text:"Read",variant:"flat",border:"",disabled:""},{default:l(()=>[h("已安装")]),_:1})):(i(),f(c,{key:0,class:"text-none mr-2",size:"small",text:"Read",variant:"flat",border:"",onClick:p=>{e.extension_url=t.repo,e.newExtension()}},{default:l(()=>[h("安装")]),_:2},1032,["onClick"]))]),_:1},8,["headers","items","loading","search"])]),_:1})])):(i(),d("div",oe,[ie,s(_,{style:{"margin-top":"16px"}},{default:l(()=>[(i(!0),d(k,null,D(e.filteredPluginMarketData,t=>(i(),f(g,{cols:"12",md:"6",lg:"6"},{default:l(()=>[s(w,{extension:t,"market-mode":"true"},null,8,["extension"])]),_:2},1024))),256))]),_:1})]))]),_:1})]),_:1})]),_:1}),s(g,{style:{"margin-bottom":"16px"},cols:"12",md:"12"},{default:l(()=>[re,h(" | "),de]),_:1})]),_:1}),s(B,{modelValue:e.dialog,"onUpdate:modelValue":a[8]||(a[8]=t=>e.dialog=t),width:"700"},{activator:l(({props:t})=>[s(c,A(t,{icon:"mdi-plus",size:"x-large",style:{position:"fixed",right:"52px",bottom:"52px"},color:"darkprimary"}),null,16)]),default:l(()=>[s(b,null,{default:l(()=>[s(C,null,{default:l(()=>[ue]),_:1}),s(S,null,{default:l(()=>[s(I,null,{default:l(()=>[s(_,null,{default:l(()=>[he,s(g,{cols:"12"},{default:l(()=>[pe,s(L,{label:"仓库链接",modelValue:e.extension_url,"onUpdate:modelValue":a[4]||(a[4]=t=>e.extension_url=t),variant:"outlined",required:""},null,8,["modelValue"])]),_:1})]),_:1}),s(_,null,{default:l(()=>[ge,s(g,{cols:"12"},{default:l(()=>[me,s(G,{label:"选择文件",modelValue:e.upload_file,"onUpdate:modelValue":a[5]||(a[5]=t=>e.upload_file=t),accept:".zip",outlined:"",required:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),ce,o("small",null,m(e.status),1)]),_:1}),s(N,null,{default:l(()=>[s(M),s(c,{color:"blue-darken-1",variant:"text",onClick:a[6]||(a[6]=t=>e.dialog=!1)},{default:l(()=>[h(" 关闭 ")]),_:1}),s(c,{color:"blue-darken-1",variant:"text",loading:e.loading_,onClick:a[7]||(a[7]=t=>e.newExtension())},{default:l(()=>[h(" 安装 ")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(U,{timeout:2e3,elevation:"24",color:e.snack_success,modelValue:e.snack_show,"onUpdate:modelValue":a[9]||(a[9]=t=>e.snack_show=t)},{default:l(()=>[h(m(e.snack_message),1)]),_:1},8,["color","modelValue"]),s(P,{ref:"wfr"},null,512)],64))}});export{be as default};
