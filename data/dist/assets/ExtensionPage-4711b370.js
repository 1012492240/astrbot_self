import{E as ne}from"./ExtensionCard-c79693d6.js";import{W as re}from"./WaitingForRestart-0476b659.js";import{A as ie}from"./AstrBotConfig-568869c1.js";import{_ as ue}from"./ConsoleDisplayer-9b3eae3d.js";import{a8 as L,r as u,a7 as de,k as ce,o as g,m as V,b as t,w as o,X as me,W as C,a9 as fe,F as I,l as p,Y as W,q as d,v,e as n,t as i,c as x,y as ge,f as j,E as b,G as E,H as P,U as D,D as U,g as N,p as pe,R as _e,V as ve,L as ye}from"./index-11f1cd8c.js";import{u as he}from"./common-34a2a7ab.js";import"./_plugin-vue_export-helper-c27b6911.js";const we={style:{"background-color":"white",width:"100%",padding:"16px","border-radius":"10px"}},ke={style:{display:"flex","align-items":"center"}},Ve=d("h3",null,"🧩 已安装的插件",-1),Ce=d("br",null,null,-1),xe=d("small",null,"详情请检查控制台",-1),be={key:1},Ee={key:1,class:"py-8 text-center"},Pe={class:"text-h4 font-weight-bold"},De={style:{"margin-top":"32px"}},Ue=d("h3",null,"日志",-1),$e={style:{"font-weight":"bold"}},Re={style:{"font-weight":"bold"}},ze={__name:"ExtensionPage",setup(Be){const F=he(),m=L({data:[],message:""}),w=u(!1),S=u(""),$=u(!1),M=u("success"),h=u(!1),f=L({metadata:{},config:{}}),T=u([]),r=L({show:!1,title:"加载中...",statusCode:0,result:""}),k=u(!1),R=u({}),B=u(""),K=u(null),G=[{title:"行为类型",key:"event_type_h"},{title:"描述",key:"desc",maxWidth:"250px"},{title:"具体类型",key:"type"},{title:"触发方式",key:"cmd"}],q=de(()=>w.value?m.data:m.data.filter(s=>!s.reserved)),X=()=>{w.value=!w.value},l=(s,e)=>{S.value=s,$.value=!0,M.value=e},A=()=>{r.show=!1,r.title="加载中...",r.statusCode=0,r.result=""},O=(s,e,a=2e3)=>{r.statusCode=s,r.result=e,a!==-1&&setTimeout(A,a)},y=async()=>{try{const s=await p.get("/api/plugin/get");Object.assign(m,s.data),z()}catch(s){l(s,"error")}},z=()=>{const s=new Map,e=new Map;T.value.forEach(a=>{a.repo&&s.set(a.repo.toLowerCase(),a),e.set(a.name,a)}),m.data.forEach(a=>{var H;const c=(H=a.repo)==null?void 0:H.toLowerCase(),oe=c?s.get(c):null,le=e.get(a.name),_=oe||le;_?(a.online_version=_.version,a.has_update=a.version!==_.version&&_.version!=="未知"):a.has_update=!1,a.logo=_==null?void 0:_.logo})},Y=async s=>{l("正在卸载"+s,"primary");try{const e=await p.post("/api/plugin/uninstall",{name:s});if(e.data.status==="error"){l(e.data.message,"error");return}Object.assign(m,e.data),l(e.data.message,"success"),y()}catch(e){l(e,"error")}},J=async s=>{r.show=!0;try{const e=await p.post("/api/plugin/update",{name:s,proxy:localStorage.getItem("selectedGitHubProxy")||""});if(e.data.status==="error"){O(2,e.data.message,-1);return}Object.assign(m,e.data),O(1,e.data.message)}catch(e){l(e,"error")}},Q=async s=>{try{const e=await p.post("/api/plugin/on",{name:s.name});if(e.data.status==="error"){l(e.data.message,"error");return}l(e.data.message,"success"),y()}catch(e){l(e,"error")}},Z=async s=>{try{const e=await p.post("/api/plugin/off",{name:s.name});if(e.data.status==="error"){l(e.data.message,"error");return}l(e.data.message,"success"),y()}catch(e){l(e,"error")}},ee=async s=>{B.value=s,h.value=!0;try{const e=await p.get("/api/config/get?plugin_name="+s);f.metadata=e.data.data.metadata,f.config=e.data.data.config}catch(e){l(e,"error")}},ae=async()=>{try{const s=await p.post("/api/config/plugin/update?plugin_name="+B.value,f.config);s.data.status==="ok"?l(s.data.message,"success"):l(s.data.message,"error"),h.value=!1,f.metadata={},f.config={},y()}catch(s){l(s,"error")}},te=s=>{R.value=s,k.value=!0},se=async s=>{try{const e=await p.post("/api/plugin/reload",{name:s});if(e.data.status==="error"){l(e.data.message,"error");return}l("重载成功","success"),y()}catch(e){l(e,"error")}};return ce(async()=>{await y();try{const s=await F.getPluginCollections();T.value=s,z()}catch(s){console.error("获取插件市场数据失败:",s)}}),(s,e)=>(g(),V(I,null,[t(me,null,{default:o(()=>[t(W,{cols:"12",md:"12"},{default:o(()=>[d("div",we,[d("div",ke,[Ve,t(v,{class:"text-none ml-2",size:"small",variant:"flat",border:"",onClick:X},{default:o(()=>[n(i(w.value?"隐藏系统保留插件":"显示系统保留插件"),1)]),_:1}),m.message?(g(),x(C,{key:0,"max-width":"500px"},{activator:o(({props:a})=>[t(v,ge(a,{icon:"",size:"small",color:"error",style:{"margin-left":"auto"},variant:"plain"}),{default:o(()=>[t(j,null,{default:o(()=>[n("mdi-alert-circle")]),_:1})]),_:2},1040)]),default:o(({isActive:a})=>[t(b,null,{default:o(()=>[t(E,{class:"headline"},{default:o(()=>[n("错误信息")]),_:1}),t(P,null,{default:o(()=>[n(i(m.message),1),Ce,xe]),_:1}),t(D,null,{default:o(()=>[t(U),t(v,{color:"primary",text:"",onClick:c=>a.value=!1},{default:o(()=>[n("关闭")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:1})):N("",!0)])])]),_:1}),(g(!0),V(I,null,pe(q.value,a=>(g(),x(W,{cols:"10",md:"6",lg:"6",key:a.name},{default:o(()=>[t(ne,{extension:a,onConfigure:c=>ee(a.name),onUninstall:c=>Y(a.name),onUpdate:c=>J(a.name),onReload:c=>se(a.name),onToggleActivation:c=>a.activated?Z(a):Q(a),onViewHandlers:c=>te(a)},null,8,["extension","onConfigure","onUninstall","onUpdate","onReload","onToggleActivation","onViewHandlers"])]),_:2},1024))),128))]),_:1}),t(C,{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=a=>h.value=a),width:"1000"},{default:o(()=>[t(b,null,{default:o(()=>[t(E,{class:"text-h5"},{default:o(()=>[n("插件配置")]),_:1}),t(P,null,{default:o(()=>[f.metadata?(g(),x(ie,{key:0,metadata:f.metadata,iterable:f.config,metadataKey:B.value},null,8,["metadata","iterable","metadataKey"])):(g(),V("p",be,"这个插件没有配置"))]),_:1}),t(D,null,{default:o(()=>[t(U),t(v,{color:"blue-darken-1",variant:"text",onClick:ae},{default:o(()=>[n("保存并关闭")]),_:1}),t(v,{color:"blue-darken-1",variant:"text",onClick:e[0]||(e[0]=a=>h.value=!1)},{default:o(()=>[n("关闭")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(C,{modelValue:r.show,"onUpdate:modelValue":e[2]||(e[2]=a=>r.show=a),width:"700",persistent:""},{default:o(()=>[t(b,null,{default:o(()=>[t(E,{class:"text-h5"},{default:o(()=>[n(i(r.title),1)]),_:1}),t(P,null,{default:o(()=>[r.statusCode===0?(g(),x(ye,{key:0,indeterminate:"",color:"primary",class:"mb-4"})):N("",!0),r.statusCode!==0?(g(),V("div",Ee,[t(j,{class:"mb-6",color:r.statusCode===1?"success":"error",icon:r.statusCode===1?"mdi-check-circle-outline":"mdi-alert-circle-outline",size:"128"},null,8,["color","icon"]),d("div",Pe,i(r.result),1)])):N("",!0),d("div",De,[Ue,t(ue,{historyNum:"10",style:{height:"200px","margin-top":"16px"}})])]),_:1}),t(D,null,{default:o(()=>[t(U),t(v,{color:"blue-darken-1",variant:"text",onClick:A},{default:o(()=>[n("关闭")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(C,{modelValue:k.value,"onUpdate:modelValue":e[4]||(e[4]=a=>k.value=a),width:"1200"},{default:o(()=>[t(b,null,{default:o(()=>[t(E,{class:"text-h5"},{default:o(()=>[n(i(R.value.name)+" 插件行为",1)]),_:1}),t(P,null,{default:o(()=>[t(_e,{style:{"font-size":"17px"},headers:G,items:R.value.handlers,"item-key":"name"},{"header.id":o(({column:a})=>[d("p",$e,i(a.title),1)]),"item.event_type":o(({item:a})=>[n(i(a.event_type),1)]),"item.desc":o(({item:a})=>[n(i(a.desc),1)]),"item.type":o(({item:a})=>[t(ve,{color:"success"},{default:o(()=>[n(i(a.type),1)]),_:2},1024)]),"item.cmd":o(({item:a})=>[d("span",Re,i(a.cmd),1)]),_:1},8,["items"])]),_:1}),t(D,null,{default:o(()=>[t(U),t(v,{color:"blue-darken-1",variant:"text",onClick:e[3]||(e[3]=a=>k.value=!1)},{default:o(()=>[n("关闭")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(fe,{timeout:2e3,elevation:"24",color:M.value,modelValue:$.value,"onUpdate:modelValue":e[5]||(e[5]=a=>$.value=a)},{default:o(()=>[n(i(S.value),1)]),_:1},8,["color","modelValue"]),t(re,{ref_key:"wfr",ref:K},null,512)],64))}};export{ze as default};
